<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<title>정보보호·개인정보보호 — 그물형 업무 흐름도</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root{
    --bg:#0b0f14; --fg:#e8f0f7; --muted:#94a3b8; --accent:#60a5fa;
    --group:#34d399; --mid:#a78bfa; --small:#f59e0b; --doc:#93c5fd;
    --flow:#ff6b6b; --connection:#4ecdc4;
  }
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--fg);
       font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
       overflow:hidden}
  header{position:absolute;left:16px;top:16px;z-index:8;background:rgba(15,23,42,.75);
         backdrop-filter:blur(6px);border:1px solid rgba(148,163,184,.2);
         border-radius:14px;padding:10px 12px}
  header h1{margin:0;font-size:16px}
  header .hint{font-size:12px;color:var(--muted)}
  .bar{position:absolute;left:16px;bottom:16px;z-index:8;display:flex;gap:10px;align-items:center;
       background:rgba(15,23,42,.75);border:1px solid rgba(148,163,184,.2);
       border-radius:14px;padding:8px 12px}
  .bar input[type="text"]{background:transparent;border:0;outline:0;color:var(--fg);padding:6px;min-width:240px}
  .bar label{font-size:12px;color:#cbd5e1;display:flex;align-items:center;gap:6px;white-space:nowrap}
  .bar input[type="range"]{width:120px}
  .bar select{background:transparent;border:1px solid rgba(148,163,184,.3);color:var(--fg);border-radius:8px;padding:4px 6px}
  svg{width:100vw;height:100vh;display:block}
  .link{stroke:rgba(148,163,184,.35);stroke-width:1.1;stroke-linecap:round}
  .flow-link{stroke:var(--flow);stroke-width:2;stroke-linecap:round;opacity:0.7}
  .cross-link{stroke:var(--connection);stroke-width:1.5;stroke-dasharray:5 5;opacity:0.6}
  .node text{pointer-events:none;fill:#dbeafe;text-shadow:0 1px 2px rgba(0,0,0,.6);font-size:11px}
  .node.group circle{fill:var(--group)} .node.mid circle{fill:var(--mid)}
  .node.small circle{fill:var(--small)} .node.doc circle{fill:var(--doc)}
  .node circle{stroke:rgba(255,255,255,.6);stroke-width:1px}
  .node.group circle{r:30} .node.mid circle{r:22} .node.small circle{r:16} .node.doc circle{r:12}
  .tooltip{position:absolute;z-index:9;pointer-events:none;transform:translate(-50%,-120%);
           min-width:220px;max-width:360px;background:rgba(2,6,23,.92);color:#e2e8f0;
           border:1px solid rgba(148,163,184,.25);border-radius:12px;padding:10px 12px;
           box-shadow:0 10px 30px rgba(0,0,0,.35);opacity:0;transition:opacity .15s}
  .tooltip .t-title{font-weight:700;font-size:13px;margin-bottom:4px}
  .tooltip a{color:var(--accent);text-decoration:none;font-weight:600}
  .panel{position:absolute;right:16px;top:16px;bottom:16px;width:360px;background:rgba(15,23,42,.75);
         border:1px solid rgba(148,163,184,.2);border-radius:14px;padding:14px;overflow:auto;z-index:8}
  .panel h2{font-size:16px;margin:0 0 8px}
  .panel .meta{font-size:12px;color:var(--muted)}
  .panel .open{display:inline-block;margin-top:10px;background:#1d4ed8;color:#fff;border:0;border-radius:10px;
               padding:8px 10px;font-weight:700;cursor:pointer}
  .dim{opacity:.15}
  .pin{stroke:#fff;stroke-width:2px}
  .flow-arrow{fill:var(--flow);opacity:0.8}
</style>
</head>
<body>
  <header>
    <h1>정보보호·개인정보보호 — 그물형 업무 흐름도</h1>
    <div class="hint">휠 줌 · 드래그 이동 · 노드 드래그(핀) · 클릭→패널 · 검색(Enter)</div>
  </header>

  <svg id="svg">
    <defs>
      <marker id="arrowhead" markerWidth="10" markerHeight="7" 
              refX="9" refY="3.5" orient="auto">
        <polygon points="0 0, 10 3.5, 0 7" class="flow-arrow" />
      </marker>
    </defs>
    <g id="viewport">
      <g id="linksFlow"></g>
      <g id="linksCross"></g>
      <g id="linksMain"></g>
      <g id="nodes"></g>
    </g>
  </svg>

  <div id="tooltip" class="tooltip"></div>

  <aside id="panel" class="panel">
    <h2>업무 흐름 정보</h2>
    <div class="meta">그래프에서 노드를 클릭하세요.</div>
  </aside>

  <div class="bar">
    <input id="q" type="text" placeholder="문서명 / 업무 단계 검색… (Enter)" />
    <label><input id="flowToggle" type="checkbox" checked> 업무 흐름</label>
    <label><input id="crossToggle" type="checkbox" checked> 교차 연결</label>
    <label>흐름 강도 <input id="flowStrength" type="range" min="0" max="100" value="60"></label>
    <button id="reheat">재정렬</button>
  </div>

<script>
/* ========= 그물형 업무 흐름 데이터 ========= */

// 개인정보보호 업무 흐름 단계
const privacyFlow = [
  {id: "privacy_law", name: "법령·제도 확인", items: [
    "개인정보 보호 법령 및 지침·고시 해설",
    "위치정보 보호법 해설", 
    "긴급상황 시 개인정보 처리 안내서",
    "자동화된 결정 권리 안내서"
  ]},
  {id: "privacy_design", name: "업무 설계·처리방침 수립", items: [
    "개인정보 처리 통합 안내서",
    "개인정보 처리방침 작성 지침",
    "홈페이지 개인정보 노출방지 안내서",
    "마이데이터 전송 절차 및 기술 가이드라인",
    "해외사업자 적용 안내서"
  ]},
  {id: "privacy_special", name: "분야별/특수 개인정보 처리", items: [
    "아동·청소년 개인정보 보호 안내서",
    "생체정보 보호 안내서",
    "스마트도시 개인정보 보호 안내서",
    "자기게시물 접근배제요청권 안내서",
    "업종별 개인정보 처리 가이드"
  ]},
  {id: "privacy_tech", name: "데이터 처리·기술적 조치", items: [
    "합성데이터 생성·활용 안내서",
    "가명정보 처리 가이드라인",
    "공공·교육·보건 분야 가명정보 안내서",
    "AI·데이터 활용 안내서",
    "개발자 대상 개인정보 보호조치 적용 안내서"
  ]},
  {id: "privacy_education", name: "교육·홍보", items: [
    "개인정보 보호 교육 업무 안내서",
    "소상공인을 위한 개인정보 보호 핸드북",
    "개인정보 질의응답 모음집"
  ]},
  {id: "privacy_cert", name: "인증·평가", items: [
    "개인정보 영향평가 수행 안내서",
    "개인정보 영향평가 대가 산정 가이드",
    "ISMS-P 인증기준 안내서"
  ]},
  {id: "privacy_incident", name: "사고 대응·취약점", items: [
    "개인정보 유출 등 사고대응 매뉴얼",
    "침해사고 분석절차 안내서"
  ]}
];

// 정보보호 업무 흐름 단계
const securityFlow = [
  {id: "security_law", name: "법령·정책/제도 확인", items: [
    "국가정보보안기본지침",
    "국가망 보안체계 가이드라인",
    "CISO 제도/운영 안내서"
  ]},
  {id: "security_tech", name: "기술·운영 지침", items: [
    "개발보안·시큐어코딩·공급망 가이드",
    "암호/암호모듈 가이드",
    "제로트러스트 가이드라인 1.0·2.0",
    "SIEM/SOAR 관제 기술 가이드",
    "AI 활용 보안 가이드라인",
    "취약점 점검/평가 지침"
  ]},
  {id: "security_finance", name: "금융·특수 도메인 적용", items: [
    "금융분야 클라우드/오픈API/암호기술 가이드",
    "금융보안 거버넌스 가이드",
    "금융회사 경영자를 위한 정보보안 경영가이드",
    "중소형 금융회사 IT 내부감사 가이드"
  ]},
  {id: "security_education", name: "교육·관리", items: [
    "CISO 길라잡이(기본편/중급편)",
    "정보보호 최고책임자 지정/신고 안내서"
  ]},
  {id: "security_incident", name: "사고 대응/보안관리", items: [
    "주요 정보통신기반시설 취약점 분석 평가",
    "금융회사 침해사고 준비도 가이드",
    "모바일 대민서비스 보안 점검 가이드"
  ]}
];

/* ========= 노드 및 링크 생성 ========= */
const nodes = [];
const linksFlow = [];
const linksCross = [];
const linksMain = [];
const pos = new Map();

const center = {x: window.innerWidth/2, y: window.innerHeight/2};

// 개인정보보호 그룹 노드
addNode("개인정보보호", "group", "개인정보보호", {x: center.x - 400, y: center.y - 200});

// 정보보호 그룹 노드  
addNode("정보보호", "group", "정보보호", {x: center.x + 400, y: center.y - 200});

// 개인정보보호 흐름 노드들
privacyFlow.forEach((stage, i) => {
  const x = center.x - 400;
  const y = center.y - 100 + i * 80;
  addNode(stage.id, "mid", stage.name, {x, y});
  addLinkMain("개인정보보호", stage.id);
  
  // 흐름 연결 (순차적)
  if (i > 0) {
    addLinkFlow(privacyFlow[i-1].id, stage.id);
  }
  
  // 문서 노드들
  stage.items.forEach((item, j) => {
    const docId = stage.id + "_doc_" + j;
    const docX = x + (j % 3 - 1) * 60;
    const docY = y + 40 + Math.floor(j / 3) * 25;
    addNode(docId, "doc", item, {x: docX, y: docY});
    addLinkMain(stage.id, docId);
  });
});

// 정보보호 흐름 노드들
securityFlow.forEach((stage, i) => {
  const x = center.x + 400;
  const y = center.y - 100 + i * 80;
  addNode(stage.id, "mid", stage.name, {x, y});
  addLinkMain("정보보호", stage.id);
  
  // 흐름 연결 (순차적)
  if (i > 0) {
    addLinkFlow(securityFlow[i-1].id, stage.id);
  }
  
  // 문서 노드들
  stage.items.forEach((item, j) => {
    const docId = stage.id + "_doc_" + j;
    const docX = x + (j % 3 - 1) * 60;
    const docY = y + 40 + Math.floor(j / 3) * 25;
    addNode(docId, "doc", item, {x: docX, y: docY});
    addLinkMain(stage.id, docId);
  });
});

// 교차 연결 (관련 업무 단계들 간)
const crossConnections = [
  ["privacy_tech", "security_tech"], // 기술적 조치
  ["privacy_cert", "security_education"], // 인증/교육
  ["privacy_incident", "security_incident"], // 사고 대응
  ["privacy_education", "security_education"], // 교육
];

crossConnections.forEach(([a, b]) => {
  addLinkCross(a, b);
});

function addNode(id, kind, label, position) {
  const node = {id, kind, label};
  nodes.push(node);
  pos.set(id, position);
  return node;
}

function addLinkMain(source, target) {
  linksMain.push({source, target});
}

function addLinkFlow(source, target) {
  linksFlow.push({source, target});
}

function addLinkCross(source, target) {
  linksCross.push({source, target});
}

/* ========= 렌더링 ========= */
const svg = document.getElementById('svg');
const viewport = document.getElementById('viewport');
const gLinksFlow = document.getElementById('linksFlow');
const gLinksCross = document.getElementById('linksCross');
const gLinksMain = document.getElementById('linksMain');
const gNodes = document.getElementById('nodes');
const tooltip = document.getElementById('tooltip');
const panel = document.getElementById('panel');

function createPath(p1, p2, className, withArrow = false) {
  const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
  path.setAttribute('class', className);
  path.setAttribute('d', `M${p1.x},${p1.y} L${p2.x},${p2.y}`);
  if (withArrow) {
    path.setAttribute('marker-end', 'url(#arrowhead)');
  }
  return path;
}

function createNodeElement(node) {
  const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
  g.setAttribute('class', `node ${node.kind}`);
  g.setAttribute('data-id', node.id);
  
  const position = pos.get(node.id);
  g.setAttribute('transform', `translate(${position.x},${position.y})`);
  
  const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
  const radius = node.kind === 'group' ? 30 : node.kind === 'mid' ? 22 : node.kind === 'small' ? 16 : 12;
  circle.setAttribute('r', radius);
  
  const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
  text.setAttribute('y', radius + 16);
  text.setAttribute('text-anchor', 'middle');
  text.textContent = shortenText(node.label, node.kind === 'doc' ? 20 : 15);
  
  g.appendChild(circle);
  g.appendChild(text);
  
  // 이벤트 리스너
  g.addEventListener('mousemove', (e) => {
    tooltip.style.left = e.pageX + 'px';
    tooltip.style.top = e.pageY + 'px';
    tooltip.style.opacity = 1;
    tooltip.innerHTML = `<div class="t-title">${escapeHtml(node.label)}</div>`;
    highlightNode(node.id, true);
  });
  
  g.addEventListener('mouseleave', () => {
    tooltip.style.opacity = 0;
    highlightNode(node.id, false);
  });
  
  g.addEventListener('click', () => {
    panel.innerHTML = `<h2>${escapeHtml(node.label)}</h2><div class="meta">${getNodeTypeText(node.kind)}</div>`;
    focusOnNode(node.id);
  });
  
  return g;
}

// 렌더링 실행
function render() {
  // 흐름 링크
  gLinksFlow.innerHTML = '';
  linksFlow.forEach(link => {
    const p1 = pos.get(link.source);
    const p2 = pos.get(link.target);
    gLinksFlow.appendChild(createPath(p1, p2, 'flow-link', true));
  });
  
  // 교차 링크
  gLinksCross.innerHTML = '';
  linksCross.forEach(link => {
    const p1 = pos.get(link.source);
    const p2 = pos.get(link.target);
    gLinksCross.appendChild(createPath(p1, p2, 'cross-link'));
  });
  
  // 메인 링크
  gLinksMain.innerHTML = '';
  linksMain.forEach(link => {
    const p1 = pos.get(link.source);
    const p2 = pos.get(link.target);
    gLinksMain.appendChild(createPath(p1, p2, 'link'));
  });
  
  // 노드
  gNodes.innerHTML = '';
  nodes.forEach(node => {
    gNodes.appendChild(createNodeElement(node));
  });
}

/* ========= 인터랙션 ========= */
function highlightNode(nodeId, highlight) {
  const connectedNodes = new Set([nodeId]);
  
  // 연결된 노드들 찾기
  [...linksMain, ...linksFlow, ...linksCross].forEach(link => {
    if (link.source === nodeId) connectedNodes.add(link.target);
    if (link.target === nodeId) connectedNodes.add(link.source);
  });
  
  // 노드 하이라이트
  [...gNodes.children].forEach(g => {
    const id = g.getAttribute('data-id');
    g.classList.toggle('dim', highlight && !connectedNodes.has(id));
  });
  
  // 링크 하이라이트
  const highlightLink = (links, elements) => {
    elements.forEach((element, i) => {
      const link = links[i];
      const isConnected = link.source === nodeId || link.target === nodeId;
      element.style.opacity = highlight ? (isConnected ? 0.9 : 0.1) : '';
    });
  };
  
  highlightLink(linksFlow, [...gLinksFlow.children]);
  highlightLink(linksCross, [...gLinksCross.children]);
  highlightLink(linksMain, [...gLinksMain.children]);
}

function focusOnNode(nodeId) {
  const position = pos.get(nodeId);
  const scale = Math.min(2, Math.max(1.2, view.k));
  const tx = window.innerWidth/2 - position.x * scale;
  const ty = window.innerHeight/2 - position.y * scale;
  view = {k: scale, tx, ty};
  applyView();
}

/* ========= 줌/팬 ========= */
let view = {k: 1, tx: 0, ty: 0};
function applyView() {
  viewport.setAttribute('transform', `translate(${view.tx},${view.ty}) scale(${view.k})`);
}

let dragging = false, startX = 0, startY = 0, startTx = 0, startTy = 0;

svg.addEventListener('mousedown', e => {
  dragging = true;
  startX = e.clientX;
  startY = e.clientY;
  startTx = view.tx;
  startTy = view.ty;
});

window.addEventListener('mouseup', () => {
  dragging = false;
});

window.addEventListener('mousemove', e => {
  if (!dragging) return;
  const dx = e.clientX - startX;
  const dy = e.clientY - startY;
  view.tx = startTx + dx;
  view.ty = startTy + dy;
  applyView();
});

svg.addEventListener('wheel', e => {
  e.preventDefault();
  const x = e.offsetX, y = e.offsetY;
  const newK = Math.max(0.5, Math.min(3, view.k * (e.deltaY > 0 ? 0.9 : 1.1)));
  const cx = (x - view.tx) / view.k;
  const cy = (y - view.ty) / view.k;
  view.tx = x - cx * newK;
  view.ty = y - cy * newK;
  view.k = newK;
  applyView();
}, {passive: false});

/* ========= 검색 ========= */
const searchInput = document.getElementById('q');
searchInput.addEventListener('keydown', (e) => {
  if (e.key !== 'Enter') return;
  
  const query = searchInput.value.trim().toLowerCase();
  const matchedNodes = new Set();
  
  nodes.forEach(node => {
    if (node.label.toLowerCase().includes(query)) {
      matchedNodes.add(node.id);
    }
  });
  
  // 검색 결과 하이라이트
  [...gNodes.children].forEach(g => {
    const id = g.getAttribute('data-id');
    const node = nodes.find(n => n.id === id);
    g.style.opacity = !query ? 1 : (matchedNodes.has(id) ? 1 : 0.2);
  });
});

/* ========= 컨트롤 ========= */
const flowToggle = document.getElementById('flowToggle');
const crossToggle = document.getElementById('crossToggle');
const reheatBtn = document.getElementById('reheat');

flowToggle.addEventListener('change', () => {
  gLinksFlow.style.display = flowToggle.checked ? 'block' : 'none';
});

crossToggle.addEventListener('change', () => {
  gLinksCross.style.display = crossToggle.checked ? 'block' : 'none';
});

reheatBtn.addEventListener('click', () => {
  // 위치 재설정 로직
  render();
});

/* ========= 유틸리티 함수 ========= */
function shortenText(text, maxLength) {
  return text.length > maxLength ? text.slice(0, maxLength - 1) + '…' : text;
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function getNodeTypeText(kind) {
  const types = {
    group: '대분류',
    mid: '업무 단계',
    small: '세부 분류',
    doc: '문서'
  };
  return types[kind] || '노드';
}

// 초기 렌더링
render();

</script>
</body>
</html>
